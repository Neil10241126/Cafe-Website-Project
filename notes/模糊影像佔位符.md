# å•†å“å½±åƒè®€å–ç™¼ç”Ÿç©ºç™½éæ¸¡

æ–°å¢æ—¥æœŸ : `2024/09/23`  
æ›´æ–°æ—¥æœŸ : 


## å‰è¨€

å•†å“å½±åƒè¼‰å…¥æ™‚ç™¼ç”Ÿè«‹æ±‚å°šæœªå®Œæˆï¼Œè€Œ`ç”¢ç”Ÿä¸€æ®µæ™‚é–“ç©ºç™½ç•«é¢`ï¼Œæƒ³è¨˜éŒ„ä¸‹é€™å€‹å•é¡Œçš„ç™¼ç”Ÿéç¨‹ä¸¦æå‡è‡ªå·±é–‹ç™¼æ™‚çš„å•é¡Œè™•ç†èƒ½åŠ›ã€‚

## äº‹ç™¼åŸå› 

ç•¶åˆå°‡å•†å“è³‡æ–™åšæˆ afterEach æ–¹å¼è™•ç†ï¼Œæ˜¯ç‚ºäº†é¿å…è«‹æ±‚æ™‚é–“éé•·å°è‡´æ•´å€‹ Page ç©ºç™½å¤ªä¹…ï¼Œæ‰€ä»¥é€²å…¥ Page å¾Œæ‰æœƒé–‹å§‹å–å¾—å•†å“é‚è¼¯ã€‚

ä½†å•†å“å½±åƒçš„è«‹æ±‚ï¼Œå»¶é²æ™‚é–“å–æ±ºæ–¼ç•¶ä¸‹`ç¶²è·¯ç’°å¢ƒ`ã€`å½±åƒå¤§å°`ç­‰ï¼Œæ‰€ä»¥æœƒé€ æˆ`ç©ºç™½éæ¸¡`ï¼Œå¦å¤–æˆ‘ä¹Ÿæ²’æœ‰çµ¦`<img>`æ’é–‹ç©ºé–“ï¼Œé€ æˆç‰ˆé¢æ–‡å­—æœƒä½ç§»ã€‚

## è§£æ±ºæ–¹å¼

æˆ‘åƒè€ƒäº† [Web Dev](https://blog.webdevsimplified.com/2023-05/lazy-load-images/) é€™ä½é–‹ç™¼è€…çš„è§£æ±ºæ–¹å¼ï¼Œå°`<img>`åŠ ä¸Š`loading="lazy"`å±¬æ€§ä¾†å»¶é²è¼‰å…¥åŸå§‹å½±åƒï¼Œä¸¦ä½¿ç”¨æº–å‚™çš„æ¨¡ç³Šå½±åƒé å…ˆæ’é–‹ç•«é¢ï¼Œå¾…è¼‰å…¥å®Œç•¢å†æ›¿æ›æ‰ï¼Œæ¸›å°‘ç©ºç™½å•é¡Œã€‚å†æ­é… Bootstrap 5 æœ¬èº«çš„ placeholder å…ƒä»¶ä¾†çµ„åˆä¸€å€‹ä½”ä½ç¬¦å¡ç‰‡ã€‚

> **å¯¦éš›çµæœ :ã€ä½”ä½ç¬¦ã€‘ â†’ ã€æ¨¡ç³Šå½±åƒã€‘ â†’ ã€åŸå§‹å½±åƒã€‘**
>
> <img src="../images/æ¨¡ç³Šå½±åƒä½”ä½ç¬¦/image.png" width="400" />


> **å½±ç‰‡æ•ˆæœ : ç¶²æ ¼å¡ç‰‡**

<img src="../images/æ¨¡ç³Šå½±åƒä½”ä½ç¬¦/imagePlaceholder-1.gif" width="400" />

> **å½±ç‰‡æ•ˆæœ : æ°´å¹³å¡ç‰‡**

<img src="../images/æ¨¡ç³Šå½±åƒä½”ä½ç¬¦/imagePlaceholder-2.gif" width="400" />

### 1. æº–å‚™æ¨¡ç³Šå½±åƒæª”æ¡ˆ

æˆ‘çš„å½±åƒå£“ç¸®æ˜¯å®‰è£ [ffmpeg]()ï¼Œæ­é… Shell Script è…³æœ¬ä¾†æ‰¹é‡è™•ç†æ‰€æœ‰åŸå§‹å½±åƒï¼Œé€™æ¨£æ¯”è¼ƒå¿«é€Ÿã€‚

### 2. è¼‰å…¥å½±åƒçš„æ–¹å¼

é¦–å…ˆå°‡è™•ç†å¥½çš„æ¨¡ç³Šå½±åƒæª”å­˜æ”¾è‡³ `/assets/images/lazy-images` è³‡æ–™å¤¾ä¸‹ï¼Œä¸¦å»ºç«‹ `useAssets.js` é€™å€‹ composables æ’°å¯«è¦è¼‰å…¥çš„è³‡æºé‚è¼¯ï¼Œä¸¦ä½¿ç”¨ `import.meta.glob` çš„æ–¹å¼è¼‰å…¥é€™äº›è³‡æºã€‚

ç”±æ–¼æˆ‘ä¸å¤§å¸Œæœ› `assets` ä¸‹çš„æ¯å±¤è³‡æºéƒ½è¢«è¼‰å…¥ï¼Œæœƒå»åˆ¤æ–· `depth` åƒæ•¸æ±ºå®šè¦æœç´¢çš„æ·±åº¦ï¼Œå†é€é `getAssetsImageSrc(fileName)` é€™å€‹å‡½æ•¸è¿”å›è¦é¡¯ç¤ºçš„æ¨¡ç³Šå½±åƒã€‚

```js
// src/composables/useAssets.js
import { computed, ref } from 'vue';

export default function useAssets(depth = 2) {
  // å„²å­˜å¼•å…¥çš„åœ–ç‰‡è³‡æº
  const imagesMap = ref({});

  // åˆå§‹åŒ–æ™‚ï¼Œæ ¹æ“š depth å±¤ç´šæœç´¢ä¸¦å¼•å…¥åœ–ç‰‡è³‡æº
  if (depth === 2) {
    const images = computed(() =>
      import.meta.glob('@/assets/images/*.{jpg,png,webp,svg}', {
        eager: true,
        import: 'default',
      })
    );
    imagesMap.value = images.value;
  } else if (depth === 3) {
    const images = computed(() =>
      import.meta.glob('@/assets/images/*/*.{jpg,png,webp,svg}', {
        eager: true,
        import: 'default',
      })
    );
    imagesMap.value = images.value;
  }

  // æ ¹æ“šæ–‡ä»¶åç¨±ç²å–åœ–ç‰‡çš„ URL
  function getAssetsImageSrc(fileName) {
    // æŠ“å‡ºæŒ‡å®šåœ–ç‰‡æ‰€åœ¨çš„ key å€¼
    const key = Object.keys(imagesMap.value).find((item) => item.includes(fileName));

    // âš ï¸è‹¥ç™¼ç”ŸéŒ¯èª¤ï¼Œå‰‡å›å‚³é è¨­å½±åƒ
    if (!imagesMap.value[key]) {
      return '/src/assets/images/lazy-images/small-image-default.svg';
    }

    // è‹¥æ­£ç¢ºï¼Œå›å‚³åœ–ç‰‡è·¯å¾‘
    return imagesMap.value[key];
  }

  return {
    getAssetsImageSrc,
  };
}
```


### 3. æº–å‚™å»¶é²è¼‰å…¥å…ƒä»¶

åŸæœ¬çš„`<img>`é¡¯ç¤ºåŸå§‹å½±åƒï¼Œä¸¦åœ¨å¤–å±¤åŒ…`<div>`ï¼Œç”¨ä¾†é¡¯ç¤ºæ¨¡ç³Šå½±åƒ

```html
// src/components/LazyloadImage.vue
<template>
  <div
    class="blur-loaded"
    :class="{ loaded: isImageLoaded }"
    :style="`background-image: url(${getAssetsImageSrc(formatTitle)})`"
  >
    <img :src="props.imageUrl" :loading="setting" @load="loaded()" alt="..." />
  </div>
</template>
```

å…ƒä»¶ä¸­ `blur-loaded`é€™å€‹ class è¡¨ç¤ºä½”ä½ç¬¦çš„è„ˆè¡æ•ˆæœã€‚

```css
<style lang="scss" scoped>
img {
  aspect-ratio: 1 / 1;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.blur-loaded {
  background-size: cover;
  background-repeat: no-repeat;
  position: relative;
}

.blur-loaded::before {
  content: '';
  position: absolute;
  inset: 0;
  animation: pulse 2.5s infinite;
}

.blur-loaded.loaded::before {
  content: none;
  animation: none;
}

@keyframes pulse {
  0% {
    background-color: rgba(255, 255, 255, 0);
  }
  50% {
    background-color: rgba(255, 255, 255, 0.3);
  }
  100% {
    background-color: rgba(255, 255, 255, 0);
  }
}

.blur-loaded > img {
  opacity: 0;
}

.blur-loaded.loaded > img {
  opacity: 1;
  transition: opacity 500ms ease-in-out;
}
</style>
```
ä½¿ç”¨ `@load` äº‹ä»¶åˆ¤æ–·åŸå§‹å½±åƒæ˜¯å¦è¼‰å…¥å®Œæˆï¼Œå®Œæˆå¾Œå°‡ `isImageLoaded` è®Šæ›´ç‚º `true` ï¼Œä¸¦è§¸ç™¼ `imageReady` äº‹ä»¶é€šçŸ¥çˆ¶çµ„ä»¶ã€‚

```js
// src/components/LazyloadImage.vue
<script setup>
import { ref, computed } from 'vue';
// å¼•å…¥ Composables æ–¹æ³•
import useAssets from '../composables/useAssets';

// å–å¾— useAssets æ–¹æ³•
const { getAssetsImageSrc } = useAssets(3);

// å®šç¾©ä½”ä½ç¬¦æ¥æ”¶åƒæ•¸ Props:
const props = defineProps({
  title: String,
  imageUrl: String,
  setting: {
    type: String,
    default: 'lazy',
  },
});

const emits = defineEmits(['imageReady']);

// åˆ¤æ–·åœ–ç‰‡æ˜¯å¦è¼‰å…¥å®Œç•¢
const isImageLoaded = ref(false);

// æ ¼å¼åŒ–æ¨™é¡Œ: å»é™¤ç©ºç™½
const formatTitle = computed(() => props.title.replace(/\s/g, ''));

// ç•¶åœ–ç‰‡è¼‰å…¥å®Œæˆæ™‚ï¼Œè§¸ç™¼äº‹ä»¶é€šçŸ¥çˆ¶çµ„ä»¶
function loaded() {
  isImageLoaded.value = true;
  emits('imageReady', isImageLoaded.value);
}
</script>
```

### 4. å¥—ç”¨è‡³çµ„ä»¶ç•¶ä¸­

å°‡ `<LazyloadImage>` å…ƒä»¶å¥—ç”¨ï¼Œä¸¦æ–°å¢ä¸€å€‹ä½”ä½ç¬¦çš„å¡ç‰‡æ¨£å¼ï¼Œé€é`v-if="!isPlaceholderLoaded"` åˆ‡æ›

> åŸç¨‹å¼ç¢¼éå¤§ï¼Œä¸‹æ–¹ç”¨ç°¡æ˜“çµæ§‹ç¯„ä¾‹ :

```html
<template>
  <!-- ç¶²æ ¼å¡ç‰‡ -->
  <div v-if="!isPlaceholderLoaded" class="card">
    <!-- åœ–ç‰‡ -->
    <div class="img-cover">
      <LazyloadImage 
        :image-url="img_url"
        :title="title"
        @image-ready="updatePlaceholderStatus"
      ></LazyloadImage>
    </div>
  
    <!-- å…§å®¹ -->
    <div class="card-body">
      <h5>è€¶åŠ é›ªè² G1</h5>
      <p class="card-text">ç”¢åœ° :è¡£ç´¢æ¯”äº</p>
      <p class="card-text">é…¸åº¦ :3åˆ†</p>
      <button>åŠ å…¥è³¼ç‰©è»Š</button>
    </div>
  </div>
  
  <!-- Bootstrap 5 ä½”ä½ç¬¦å¡ç‰‡ -->
  <div v-else class="card">
    <!-- åœ–ç‰‡ -->
    <div class="img-cover">
      <LazyloadImage 
        :image-url="img_url"
        :title="title"
        @image-ready="updatePlaceholderStatus"
      ></LazyloadImage>
    </div>
  
    <!-- å…§å®¹ -->
    <div class="card-body placeholder-glow">
      <h5 class="placeholder col-5"></h5>
      <p class="placeholder col-8"></p>
      <p class="placeholder col-5"></p>
      <button class="btn btn-primary placeholder w-100"></button>
    </div>
  </div>
</template>
```

```js
// src/components/ProductCard.vue
<script setup>
import { ref } from 'vue';
// å¼•å…¥ UI çµ„ä»¶
import LazyloadImage from '@/components/LazyloadImage.vue';

const props = defineProps({
  title: String,
  img_url: String,
});

// ä½”ä½ç¬¦è¼‰å…¥ç‹€æ…‹
const isPlaceholderLoaded = ref(true);

// æ›´æ–°ä½”ä½ç¬¦ç‹€æ…‹
const updatePlaceholderStatus = (status) => {
  isPlaceholderLoaded.value = !status;
};
</script>
```


## çµè«–èˆ‡åæ€

ç•¶åˆåšä½œå“æ™‚ï¼Œå°é€™äº›è³‡æºè¼‰å…¥æ™‚çš„è™•ç†æ²’æœ‰ç‰¹åˆ¥æ³¨æ„éï¼Œä¹Ÿæ˜¯çœ‹äº†åˆ¥äººå½±ç‰‡ç‰¹åˆ¥æåˆ°æ‰ç™¼ç¾è‡ªå·±æœ‰é€™å€‹å•é¡Œï¼Œ`å¾ç†è§£å•é¡Œåˆ°è§£æ±ºå¤§è©²èŠ±äº†æˆ‘ä¸€å€‹ç¦®æ‹œå·¦å³å§ğŸ¥²`ï¼Œæ„Ÿè¦ºè§£æ±ºé€Ÿåº¦ä¸å¤ åŠæ ¼ï¼Œæˆ‘ä¹Ÿåšä¸€å€‹[Stackblitzç¯„ä¾‹](https://stackblitz.com/edit/vitejs-vite-kajxom?file=src%2FApp.vue)ã€[Notino-æ¨¡ç³Šå½±åƒä½”ä½ç¬¦](https://www.notion.so/108768c74d5d807b8f20fa6623c3f8ca?pvs=4)ä¾†è¨˜éŒ„ã€‚

ç›®å‰ä¹Ÿå°‡æ‡‰ç”¨å…ˆè™•ç†å†ç”¢å“é çš„éƒ¨åˆ†ï¼Œå…¶ä»–çš„ Page æœƒå†æ…¢æ…¢è£œä¸Šã€‚

## åƒè€ƒè³‡æ–™

- [Web Dev | ä½¿ç”¨å»¶é²å½±åƒåŠ å¿«ç¶²ç«™é€Ÿåº¦](https://blog.webdevsimplified.com/2023-05/lazy-load-images/)